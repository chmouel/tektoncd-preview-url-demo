---
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: post-back
spec:
  inputs:
    resources:
    - name: source
      type: git
    - name: pr
      type: pullRequest
  outputs:
    resources:
      - name: pr
        type: pullRequest
  steps:
    - name: hello
      image: registry.access.redhat.com/ubi8/ubi-minimal:latest
      script: |
        #!/usr/bin/env bash
        set -e

        mkdir -p $(outputs.resources.pr.path)
        cp -r $(inputs.resources.pr.path)/* $(outputs.resources.pr.path)/

        echo "Hello from pullRequest" > $(outputs.resources.pr.path)/comments/new.json

---
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: deploy
spec:
  inputs:
    resources:
    - name: source
      type: git
    - name: pr
      type: pullRequest
  steps:
  - name: deploy
    workingDir: $(inputs.resources.source.path)
    image: quay.io/openshift/origin-cli:latest
    script: |
      #!/usr/bin/env bash
      set -xe
      sha=$(python -c "import json, sys;r = json.loads(sys.stdin.read());print(r['Sha'][1:8])" < $(inputs.resources.pr.path)/pr.json)
      oc delete -f <(sed "s/%SHA%/${sha}/g" deployment.yaml) 2>/dev/null || true
      oc create -f <(sed "s/%SHA%/${sha}/g" deployment.yaml)
      sleep infinity
---
apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: simple
spec:
  resources:
    - name: image
      type: image
    - name: pr
      type: pullRequest
    - name: source
      type: git
  tasks:
  - name: build
    taskRef:
      name: buildah
    params:
      - name: TLSVERIFY
        value: "false"
    resources:
      inputs:
        - name: source
          resource: source
      outputs:
        - name: image
          resource: image
  - name: deploy
    runAfter: [build]
    taskRef:
      name: deploy
    resources:
      inputs:
        - name: source
          resource: source
        - name: pr
          resource: pr
  # - name: check-code
  #   taskRef:
  #     name: hello-world
  #   resources:
  #     inputs:
  #       - name: source-repo
  #         resource: source-repo
  #       - name: pr
  #         resource: pr
